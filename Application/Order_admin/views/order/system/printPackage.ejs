<%- include('../layouts/head_top'); %>
<%- include('../layouts/head_bottom'); %>
<%- include('../layouts/header'); %>
<%- include('../layouts/nav'); %>

<style>
  hr {
    border-top: 3px dotted #000 !important;
  }
</style>
<div id="main" role="main">

  <div id="ribbon">

    <ol class="breadcrumb">
      <li>后台管理</li>
      <li><a class="back-url" href="<%= backPath %>"> <i class="fa fa-chevron-left"></i>返回</a></li>
      <li>打印预览</li>
    </ol>


  </div>
  <div id="content">

    <% var printINfoKeys = Object.keys(printINfo) %>

    <div class="prin-preview">

      <div class="orderItemLayerTit">
        <ul class="orderItemMenu">

          <% if(DWY_Helper.isCanLoop(printINfoKeys)){
          printINfoKeys.forEach(function (element, index) { %>

          <li class="<%= (DWYRequest.query.type == element) ? 'materielBak' : '' %>">
            <a href="/system/printParts/<%= batchNumber %>/<%= factoryId %>?type=<%= element %>"><%= element %> </a>
          </li>

          <% }) } %>
        </ul>
      </div>

      <div><%- pagination %></div>

      <div id="printHtml">

        <% if(DWY_Helper.isCanLoop(printINfo[showTYpe].result)){
        printINfo[showTYpe].result.forEach(function (element, index) { %>

        <div class="printBody nopadding-table">
          <%- element %>
        </div>

        <% })
        } %>

      </div>


      <div id="printArea" class="display-none"></div>

    </div>

    <div class="form-horizontal fix-print">
      <form class="form-horizontal" method="post" action="" id="print-form">
        <div class="form-group">
          <label class="pull-left control-label">纸张大小:</label>
          <div class="col-xs-8">
            <select class="form-control" name="stcode">
              <option value="0">A4</option>
              <option value="1">小票</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="pull-left control-label">打印分类:</label>
          <div class="col-xs-8">
            <% if(DWY_Helper.isCanLoop(printINfoKeys)){
            printINfoKeys.forEach(function (element, index) { %>

            <label class="checkbox-inline">
              <input type="checkbox" class="checkbox validate[minCheckbox[1]]"
                     name="printType" value="<%= element %>" data-totalItems="<%= packageNum[element] %>">
              <span><%= element %></span>
            </label>
            <% }) } %>
          </div>
        </div>
        <div class="form-group" id="pageNumInputDiv" style="display: none">
          <p><label class="control-label text-success margin-bottom-10">已勾选的分类共 <span id="pageInfo">0</span> 页（10条/页）</label>
          </p>
          <label class="pull-left control-label">打印页码:</label>
          <div class="col-xs-8">
            <label class="control-label pull-left">第 </label>
            <div class="col-xs-8" id="pageNumInput">
              <input class="form-control validate[required, custom[integer],min[1],max[100]]" placeholder="1~100"
                     type="text"
                     name="spaceRow" value="">
            </div>
            <label class="control-label ">页 </label>

          </div>
        </div>
        <label class="btn btn-primary " id="print">
          <i class="fa fa-print"></i>&nbsp;
          打印
        </label>
      </form>
    </div>

  </div>
  <!-- END MAIN CONTENT -->

</div>
<!-- END MAIN PANEL -->

<div class="printLoading">
  <p>正在获取数据。。。</p>
</div>

<%- include('../layouts/footer'); %>
<%- include('../layouts/footer_common_script'); %>
<script src="/asset/js/jQuery.print.js"></script>

<script type="text/javascript">

    $(document).ready(function () {

        $("#print-form").validationEngine({scroll: false});

        var loadIndex;
        var totalNum = 0;
        $('body').on('click', '#print', function () {
            if ($("#print-form").validationEngine('validate')) {
                var value = [];
                var page = $('#printPageNo').val();
                $("input[name=printType]:checked").each(function () {
                    value.push($(this).val())
                });
                loadIndex = layer.load(0, {
                    shade: [0.2, '#000']
                });

                var html = "";

                getList(value, html, page);
            }
        })


        $(':checkbox').change(function () {
            totalNum = 0;
            if ($("input[name=printType]:checked").length > 0) {
                $('#pageNumInputDiv').show();
                $("input[name=printType]:checked").each(function () {
                    totalNum += parseInt($(this).attr('data-totalItems'));
                });
                var totalPage = Math.ceil(totalNum / 10);
                $("#pageInfo").text(totalPage)
                $("#pageNumInput").html(
                    ' <input class="form-control validate[required, custom[integer],min[1],max[' + totalPage + ']]" placeholder="1~' + totalPage + '" type="text" ' +
                    'id="printPageNo" value="">'
                )
            } else {
                $('#pageNumInputDiv').hide();
            }

        })

        function getList(types, html, page) {
            var typeString = types.toString(',');
            $.ajax({
                url: '/system/printParts/ajax/<%= batchNumber %>/<%= factoryId %>?pageNo=' + page + '&pageSize=10&type=' + typeString,
                method: 'get',
                success: function (data) {

                    var resultData = JSON.parse(data);

                    resultData.forEach(function (element) {
                        html += '<div class="printBody nopadding-table">' + element + ' </div>';
                    })
                    $('#printArea').print({
                        stylesheet: "/css/print.css",
                        // timeout: 750,
                        prepend: html,
                        // deferred: $.Deferred(test),
                    });

                    layer.close(loadIndex);


//          types.forEach(function (type) {
//            if(resultData[type].result.length > 0){
//              resultData[type].result.forEach(function (element) {
//                html += '<div class="printBody nopadding-table">'+element+' </div>';
//              })
//            }
//          })

//                    if (resultData[types[0]].totalPages > page) {
//                        getList(types, html, page + 1)
//                    } else {
//
//                        $('#printArea').print({
//                            stylesheet: "/css/print.css",
//                            // timeout: 750,
//                            prepend: html,
//                            // deferred: $.Deferred(test),
//                        });
//
//                        layer.close(loadIndex);
//                    }

                },
                error: function (response) {
                    errorLayout.normal(response);
                }
            });

        }


    })

</script>


<%- include('../layouts/foot'); %>