<%- include('../layouts/head_top'); %>
<%- include('../layouts/head_bottom'); %>
<%- include('../layouts/header'); %>
<%- include('../layouts/nav'); %>

<!-- MAIN PANEL -->
<div id="main" role="main">

    <!-- RIBBON -->
    <div id="ribbon">

        <!-- breadcrumb -->
        <ol class="breadcrumb">
            <li>后台管理</li>
            <li><a class="back-url" href="/purchase">已请购列表</a></li>
            <li>请购详情</li>
            <li><a class="back-url" href="javascript:history.go(-1)"> <i class="fa fa-chevron-left"></i>返回</a></li>
        </ol>
        <!-- end breadcrumb -->
    </div>
    <!-- END RIBBON -->
    <!-- MAIN CONTENT -->
    <div id="content">
        <div class="well">
            <!-- row -->
            <div class="row">
                <!-- col -->
                <div class="col-xs-12">
                    <legend>
                        请购详情
                    </legend>
                </div>
            </div>
            <!--<div class="row">-->
            <!--<div class="col-xs-12">-->
            <!--<div class="col-xs-3">-->
            <!--<a class="btn btn-primary" href="/purchase/detail">生成采购单</a>-->
            <!--</div>-->
            <!--</div>-->
            <!--</div>-->
            <div class="row margin-top-10">
                <div class="col-xs-12">
                    <div class="orderItemLayerTable">
                        <table class="table table-bordered table-striped table-information" id="purchaseTable">
                            <tbody>
                            <tr>
                                <td>请购单号</td>
                                <td class="reqid"><%= purchaseRequestDetail.id %></td>
                                <td>请购人</td>
                                <td><%= purchaseRequestDetail.addEmpName %></td>
                            </tr>
                            <tr>
                                <td>请购人部门</td>
                                <td><%= purchaseRequestDetail.addDeptName %></td>
                                <td>请购时间</td>
                                <td><%= DWY_Helper.getLocalDate(purchaseRequestDetail.addTime) %></td>
                            </tr>
                            <tr>
                                <td>审核人</td>
                                <td><%= purchaseRequestDetail.reviewEmp %></td>
                                <td>审核人部门</td>
                                <td><%= purchaseRequestDetail.reviewDeptName %></td>
                            </tr>
                            <tr>
                                <td>审核时间</td>
                                <td><%= DWY_Helper.getLocalDate(purchaseRequestDetail.reviewTime) %></td>
                                <td>生成时间</td>
                                <td><%= DWY_Helper.getLocalDate(purchaseRequestDetail.buildTime) %></td>
                            </tr>
                            <tr>
                                <td>请购状态</td>
                                <td>
                                    <% if(purchaseRequestDetail.stcode == 10 ){ %>请购中<% } %>
                                    <% if(purchaseRequestDetail.stcode == 30 ){ %>已审核<% } %>
                                    <% if(purchaseRequestDetail.stcode == 50 ){ %>已生成<% } %>
                                </td>
                                <td>操作</td>
                                <td>
                                    <% if(purchaseRequestDetail.stcode == 30 ){ %>
                                    <% if (DWY_Helper.hasPermission(Permission.purchase.create.id, permission) ){ %>
                                    <button class="label label-primary" id="PurchaseOrder">生成采购单</button>
                                    <% } %>
                                    <% } %>
                                    <% if(purchaseRequestDetail.stcode == 10 ){ %>
                                    <% if (DWY_Helper.hasPermission(Permission.request.check.id, permission) ){ %>

                                    <% if(purchaseRequestDetail.reqType==30){%>
                                    <button class="label label-primary purchaseReview" id="purchaseReview"   <%= (purchaseRequestDetail.isAssign==1)?'disabled=disabled style=background-color:#ccc':'' %> >审核</button>
                                    <% }else{ %>
                                    <button class="label label-primary" id="purchaseReview">审核</button>
                                    <% } %>
                                    <% } %>
                                    <% } %>
                                    <% if(purchaseRequestDetail.stcode == 50 ){ %>
                                    <a class="label label-primary" href="/purchase/detail">查看采购列表</a>
                                    <% } %>
                                </td>
                            </tr>
                            <input type="hidden" value="<%= purchaseRequestDetail.id %>" id="purchaseId">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-xs-12">
                    <div class="row">
                        <!-- col -->
                        <div class="col-xs-12">
                            <legend>
                                请购清单
                                <button class="label label-primary <%= (purchaseRequestDetail.reqType==30)?'':'display-none' %>" id="edit-supp">修改供应商</button><span class="<%= (purchaseRequestDetail.reqType==30)?'':'display-none' %>" style="padding-left:20px;color:#d9534f;font-size:14px;">请选择供应商！</span>
                            </legend>
                        </div>
                    </div>
                    <div class="orderItemLayerTable">
                        <table class="table table-bordered table-striped table-hover" id="purchaseTable">
                            <thead>
                            <tr>
                                <th>物料编号</th>
                                <th>物料名称</th>
                                <th>供应商编号</th>
                                <th>供应商名称</th>
                                <th>数量</th>
                                <th>单位</th>
                                <th>最小数量</th>
                                <th>预计交付时间</th>
                                <th>采购单编号</th>
                            </tr>
                            </thead>
                            <tbody>
                            <%
                            if(DWY_Helper.isCanLoop(purchaseRequestDetail.reqMaters)){
                            purchaseRequestDetail.reqMaters.forEach(function (element, index) { %>
                            <tr class="reqTr">
                                <td class="mateId<%= index %>">
                                    <a href="/materialManage/detail/<%= bid %>/<%= element.mateId %>"><%= element.mateId %></a>
                                </td>
                                <td><%= element.mateName %></td>
                                <td>
                                    <% if(element.suppId=='0'){%>
                                    <%}else{%>
                                    <%= element.suppId %>
                                    <%}%>
                                </td>
                                <td>
                                        <%
                                        if(purchaseRequestDetail.reqType==30){
                                        %>
                                        <select class="form-control purchase-select purchase-select-sec<%= index %>" id="">
                                            <%
                                            if(DWY_Helper.isCanLoop(element.suppliers)){
                                            element.suppliers.forEach(function (supp, num) { %>
                                            <option value="<%= supp.id %>"  <%= (element.suppName == supp.name)?"selected":"" %>><%= supp.name %></option>
                                            <%})}%>
                                        </select>
                                        <%}else{%>
                                        <%= element.suppName %>
                                       <% }%>
                                </td>
                                <td><%= element.amount %></td>
                                <td><%= element.unitName %></td>
                                <td><%= element.minAmount %></td>
                                <td><%= DWY_Helper.getLocalDate(element.deliveryDate) %></td>
                                <td><%= element.orderId %></td>
                                <input type="hidden" name="tid" value="<%= element.tid %>" />
                            </tr>
                            <%
                            }
                            )}%>
                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('../layouts/footer'); %>
<%- include('../layouts/footer_common_script'); %>
<script type="text/javascript">
    $(document).ready(function () {
        pageSetUp();
//        $(".orderItemMenu li").click(function(){
//            $(this).addClass("selected").siblings().removeClass("selected");
//            $(".orderItemLayerTable table").eq($(this).index()).show().siblings().hide();
//        });
        $("#PurchaseOrder").click(function(){
            var tid=$("#purchaseId").val();
            layer.confirm('确认生成采购单?',{icon: 3, title:'提示'},
                function(index){
                    $.ajax({
                        url: '/purchases/Order/'+tid,
                        method: 'post',
                        success: function (data) {
                            successLayout.hrefTo("/purchase/detail");
                        },
                        error: function (response) {
                            layer.close(index)
                            errorLayout.normal(response);
                        }
                    });
                },
                function(index){layer.close(index)})
        })
        //请购单审核
        $("#purchaseReview").click(function(){
            var tid=$("#purchaseId").val();
            layer.confirm('确认审核?',{icon: 3, title:'提示'},
                function(index){
                    $.ajax({
                        url: '/purchase/applyReview/'+tid,
                        method: 'post',
                        success: function (data) {
                            successLayout.reload();

                        },
                        error: function (response) {
                            layer.close(index)
                            errorLayout.normal(response);
                        }
                    });
                },
                function(index){layer.close(index)})
        })


        $("#edit-supp").click(function(){
            var reqId = $(".reqid").text();
            var tid = $("input[name=tid]").val();
            var leng = $(".reqTr").length;
            var arr = new Array();
            for(var i=0;i<leng;i++){
                var obj = new Object();
                var mateId = $(".mateId"+i).find("a").text();
                var suppId = $(".purchase-select-sec"+i).find("option:selected").val();
                var suppName = $(".purchase-select-sec"+i).find("option:selected").text();
                obj.reqId=reqId;
                obj.tid=tid;
                obj.mateId=mateId;
                obj.suppId=suppId;
                obj.suppName=suppName;
                arr.push(obj);
            }
            var datas = {reqMaterialList: arr};
            console.log(datas)
            layer.confirm("确认提交？", {title: '提示'}, function (index) {
                    $.ajax({
                        url: '/purchase/applyModify',
                        data: JSON.stringify(datas),
                        method: 'post',
                        dataType: 'json',
                        contentType: "application/json",
                        success: function (data) {
                            location.href = "/purchase/applyDetail/"+reqId;
                        },
                        error: function (response) {
                            if (response.status == 200) {
                                successLayout.hrefTo("/purchase/applyDetail/"+reqId);
                            } else {
                                layer.close(index)
                                errorLayout.normal(response);
                            }
                        }
                    });
                }, function (index) {
                    layer.close(index)
                }
            )


        })

    })
</script>
<%- include('../layouts/foot'); %>